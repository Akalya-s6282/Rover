<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Rover</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/index.css') }}"
    />
  </head>
  <body>
    <aside>
      <div class="brand">Rover.</div>
      <nav class="menu">
        <a href="#" class="active">Overview</a>
        <a href="#">Active Robots</a>
        <a href="#">Order History</a>
        <a href="{{ url_for('users.configure_system') }}">Settings</a>
        <a href="{{ url_for('auth.logout') }}" class="logout-link">Log Out</a>
      </nav>
    </aside>

    <main>
      <header>
        <h1>Dashboard</h1>
        <div class="header-meta">
          Hotel: {{ hotel_name }} ‚Ä¢ Shift: {{ shift }} ‚Ä¢ Time: {{ current_time }}
        </div>
      </header>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-label">Active Robots</div>
          <div class="stat-value">
            {{ active_rovers }}/{{ rovers | length }}
          </div>
          <div class="stat-foot success">‚óè Systems Normal</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Deliveries Today</div>
          <div class="stat-value">{{ deliveries_today }}</div>
          <div class="stat-foot success">‚óè Live from database</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg. Delivery Time</div>
          <div class="stat-value">{{ avg_delivery_time }}</div>
        </div>
      </div>

      <div class="table-container">
        <div class="table-head">
          <h3>Live Deliveries</h3>
          <button class="btn-action" onclick="toggleForm()">+ Add Rover</button>
        </div>
        <table>
          <thead>
            <tr>
              <th>ROBOT ID</th>
              <th>STATUS</th>
              <th>AISLE</th>
              <th class="col-center">TABLE NO</th>
              <th class="col-action">ACTION</th>
            </tr>
          </thead>
          <tbody>
            {% for rover in rovers %}
            {% if rover.positions %}
            {% set pos = rover.positions[-1] %}
            {% set status_text = pos.status %}
            {% set status_lower = (pos.status or '')|lower %}
            {% if 'busy' in status_lower or 'transit' in status_lower %}
              {% set status_class = 'status-busy' %}
            {% else %}
              {% set status_class = 'status-active' %}
            {% endif %}
            {% set aisle_val = rover.location_lat if rover.location_lat else None %}
            {% set table_val = rover.location_lon if rover.location_lon else None %}
            <tr>
              <td><strong>{{ rover.id }}</strong></td>
              <td><span class="status-dot {{ status_class }}"></span> {{ status_text }}</td>
              <td>{{ aisle_val if aisle_val is not none else '‚Äî' }}</td>
              {% if table_val is not none %}
              <td class="col-center">{{ table_val }}</td>
              {% else %}
              <td class="col-center placeholder">‚Äî</td>
              {% endif %}
              <td class="col-action">
                <div class="action-group">
                  <a
                    class="btn-action link"
                    href="{{ url_for('users.assign_coordinates', rover_id=rover.id) }}"
                  >Assign</a>
                  <form
                    action="{{ url_for('users.delete_rover', rover_id=rover.id) }}"
                    method="post"
                    class="delete-form"
                  >
                    <button type="submit" class="btn-icon" title="Delete">üóë</button>
                  </form>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td><strong>{{ rover.id }}</strong></td>
              <td><span class="status-dot status-idle"></span> Idle</td>
              <td>‚Äî</td>
              <td class="col-center placeholder">‚Äî</td>
              <td class="col-action">
                <div class="action-group">
                  <a
                    class="btn-action link"
                    href="{{ url_for('users.assign_coordinates', rover_id=rover.id) }}"
                  >Assign</a>
                  <form
                    action="{{ url_for('users.delete_rover', rover_id=rover.id) }}"
                    method="post"
                    class="delete-form"
                  >
                    <button type="submit" class="btn-icon" title="Delete">üóë</button>
                  </form>
                </div>
              </td>
            </tr>
            {% endif %}
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="table-container history">
        <div class="table-head">
          <h3>Order History</h3>
        </div>
        <table>
          <thead>
            <tr>
              <th>ROBOT ID</th>
              <th>STATUS</th>
              <th>STARTED</th>
              <th>COMPLETED</th>
            </tr>
          </thead>
          <tbody>
            {% for delivery in order_history %}
            <tr>
              <td><strong>{{ delivery.rover_id }}</strong></td>
              <td>{{ delivery.status.replace('_', ' ').title() }}</td>
              <td>
                {% if delivery.started_at %}
                  {{ delivery.started_at.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
              <td>
                {% if delivery.completed_at %}
                  {{ delivery.completed_at.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  ‚Äî
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="4">No deliveries yet.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </main>

    <!-- Modal Form -->
    <div id="formModal" class="form-modal">
      <div class="form-container">
        <button class="close-btn" onclick="toggleForm()">&times;</button>
        <h2>Add New Rover</h2>
        <form id="addForm" method="POST">
          <input type="text" name="id" placeholder="Rover ID" required />
          <input type="text" name="name" placeholder="Rover Name" required />
          <button type="submit" class="submit-btn">Add Rover</button>
        </form>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
  </body>
</html>
